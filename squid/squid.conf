http_port 3128

# Client networks
# Avoid using the ACL name "localhost" to prevent duplicate/overlap warnings on some builds
acl localonly src 127.0.0.1/32
acl localonlyv6 src ::1
# Match your LAN; aligns with docker-compose macvlan subnet 192.168.1.0/24
acl localnet src 192.168.1.0/24
acl dockerbridge src 172.17.0.0/16

# Allow common private networks used by CI/user-defined bridges for Jenkins Tests
acl private_nets src 10.0.0.0/8
acl private_nets src 172.16.0.0/12
acl private_nets src 192.168.0.0/16

# Ports and methods
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 1025-65535
acl CONNECT method CONNECT

# Access rules (order matters)
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localonly
http_access allow localonlyv6
http_access allow localnet
http_access allow dockerbridge
http_access allow private_nets
http_access deny all

# Use memory-only cache_dir to avoid a known UFS allocation bug on some platforms
cache_dir null /var/spool/squid
cache_mem 64 MB
maximum_object_size 4 MB
minimum_object_size 0 KB
memory_pools off

# Limit file descriptors to avoid giant allocations on hosts with unlimited ulimit
max_filedescriptors 16384